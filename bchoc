#!/usr/bin/env python3
import os
import importlib
import logging
import sys

# Get blockchain file path from environment variable
BLOCKCHAIN_FILE = os.getenv('BCHOC_FILE_PATH', 'blockchain.bin')

def load_modules():
    modules = {}
    for filename in os.listdir('.'):
        if filename.endswith('.py') and filename != 'main.py':
            module_name = filename[:-3]
            module = importlib.import_module(module_name)
            modules[module_name] = module
    return modules

def main():
    # Set up logging
    logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

    # Get command from command line arguments
    if len(sys.argv) < 2:
        print("Error: No command provided")
        sys.exit(1)

    command = sys.argv[1].lower()
    
    if command == 'init':
        # Check for additional parameters
        if len(sys.argv) > 2:
            print("Error: init command takes no parameters")
            sys.exit(1)
            
        if os.path.exists(BLOCKCHAIN_FILE):
            try:
                from block import Block
                from blockchain import Blockchain
                
                # Try to load the blockchain - this will validate the file structure
                blockchain = Blockchain(BLOCKCHAIN_FILE)
                if len(blockchain.blocks) > 0:  # If we can load blocks, file is valid
                    print("Blockchain already initialized")
                    sys.exit(0)
                else:  # No valid blocks found
                    print(f"Error: Failed to load blockchain from {BLOCKCHAIN_FILE}")
                    sys.exit(1)
            except Exception as e:
                print(f"Error: Failed to load blockchain from {BLOCKCHAIN_FILE}")
                sys.exit(1)
        else:
            # Create new blockchain file with initial block
            try:
                from block import Block
                from blockchain import Blockchain
                
                # Create blockchain with the specified file
                blockchain = Blockchain(BLOCKCHAIN_FILE)
                # Initialize it with genesis block
                blockchain.init_blockchain()
                
                print("Blockchain initialized")
                sys.exit(0)
            except Exception as e:
                print(f"Error: Failed to create blockchain file: {str(e)}")
                sys.exit(1)
    elif command == 'add':
        try:
            from add import run
            run()
            sys.exit(0)
        except Exception as e:
            print(f"Error: {str(e)}")
            sys.exit(1)
    elif command == 'verify':
        try:
            from verify import run
            run()
            sys.exit(0)
        except Exception as e:
            print(f"Error: {str(e)}")
            sys.exit(1)
    elif command == 'show':
        try:
            from show_history import run
            run()
            sys.exit(0)
        except Exception as e:
            print(f"Error: {str(e)}")
            sys.exit(1)
    else:
        print(f"Unknown command: {command}")
        sys.exit(1)

def test_evidence_id_encryption():
    from crypto.Cipher import AES
    import struct
    
    # Test values
    encrypted_hex = "2764036c5610b47cc74ee7d815f836f0"
    key = b'R0chLi4uLi4uLi4='
    expected_id = 3879675510

    print("\nTesting Evidence ID Encryption/Decryption:")
    print(f"Starting with encrypted hex: {encrypted_hex}")
    
    # Decrypt
    encrypted_bytes = bytes.fromhex(encrypted_hex)
    cipher = AES.new(key, AES.MODE_ECB)
    decrypted = cipher.decrypt(encrypted_bytes)
    evidence_id = struct.unpack('>I', decrypted[:4])[0]
    print(f"Decrypted evidence ID: {evidence_id}")
    
    # Encrypt back
    item_id_bytes = struct.pack('>I', evidence_id).ljust(16, b'\x00')
    cipher = AES.new(key, AES.MODE_ECB)
    encrypted = cipher.encrypt(item_id_bytes)
    print(f"Re-encrypted hex: {encrypted.hex()}")
    
    # Verify
    print(f"Matches original: {encrypted.hex() == encrypted_hex}")

if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "test":
        test_evidence_id_encryption()
    else:
        main()